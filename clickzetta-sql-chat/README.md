# ClickZetta SQL æ™ºèƒ½é—®ç­”

åŸºäº ClickZetta çš„ SQL æ™ºèƒ½é—®ç­”ç³»ç»Ÿï¼Œæ”¯æŒè‡ªç„¶è¯­è¨€è½¬ SQL æŸ¥è¯¢ï¼Œè®©æ•°æ®åˆ†æå˜å¾—åƒèŠå¤©ä¸€æ ·ç®€å•ã€‚

## âœ¨ åŠŸèƒ½ç‰¹æ€§

- ğŸ§  **è‡ªç„¶è¯­è¨€è½¬ SQL** - ç”¨ä¸­æ–‡æè¿°éœ€æ±‚ï¼Œè‡ªåŠ¨ç”Ÿæˆ SQL æŸ¥è¯¢
- ğŸ’¾ **æ™ºèƒ½æ•°æ®åº“åˆ†æ** - è‡ªåŠ¨è·å–è¡¨ç»“æ„å’Œå…ƒæ•°æ®ä¿¡æ¯
- ğŸ’¬ **å¯¹è¯å¼æŸ¥è¯¢** - æ”¯æŒä¸Šä¸‹æ–‡ç†è§£çš„å¤šè½®å¯¹è¯
- ğŸ“Š **ç»“æœå¯è§†åŒ–** - è‡ªåŠ¨å±•ç¤ºæŸ¥è¯¢ç»“æœä¸ºè¡¨æ ¼å½¢å¼
- ğŸ“š **æŸ¥è¯¢å†å²** - å®Œæ•´çš„æŸ¥è¯¢è®°å½•å’Œæ€§èƒ½ç»Ÿè®¡
- ğŸ” **å¿«é€ŸæŸ¥è¯¢å»ºè®®** - é¢„è®¾å¸¸ç”¨æŸ¥è¯¢æ¨¡æ¿
- ğŸ“¥ **ç»“æœå¯¼å‡º** - æ”¯æŒ CSV æ ¼å¼æ•°æ®å¯¼å‡º
- ğŸš€ **é«˜æ€§èƒ½** - åŸºäº ClickZetta çš„é«˜é€Ÿæ•°æ®å¤„ç†

## ğŸ¯ é€‚ç”¨åœºæ™¯

### 1. ä¸šåŠ¡åˆ†æå¸ˆ
- **åœºæ™¯**: æ—¥å¸¸æ•°æ®åˆ†æã€æŠ¥è¡¨ç”Ÿæˆ
- **ä¼˜åŠ¿**: æ— éœ€æŒæ¡å¤æ‚ SQL è¯­æ³•
- **ç¤ºä¾‹**: "æŸ¥è¯¢æœ¬æœˆé”€å”®é¢æœ€é«˜çš„å‰10ä¸ªäº§å“"

### 2. äº§å“ç»ç†
- **åœºæ™¯**: ç”¨æˆ·è¡Œä¸ºåˆ†æã€äº§å“æ•°æ®æ´å¯Ÿ
- **ä¼˜åŠ¿**: å¿«é€Ÿè·å–ä¸šåŠ¡æŒ‡æ ‡
- **ç¤ºä¾‹**: "ç»Ÿè®¡æ¯ä¸ªåŠŸèƒ½æ¨¡å—çš„ç”¨æˆ·ä½¿ç”¨ç‡"

### 3. è¿è¥äººå‘˜
- **åœºæ™¯**: è¿è¥æ•°æ®ç›‘æ§ã€æ•ˆæœè¯„ä¼°
- **ä¼˜åŠ¿**: å®æ—¶æŸ¥è¯¢è¿è¥æŒ‡æ ‡
- **ç¤ºä¾‹**: "æ‰¾å‡ºæœ€è¿‘ä¸€å‘¨æ´»è·ƒåº¦ä¸‹é™çš„ç”¨æˆ·"

### 4. æ•°æ®ç§‘å­¦å®¶
- **åœºæ™¯**: æ¢ç´¢æ€§æ•°æ®åˆ†æã€ç‰¹å¾å·¥ç¨‹
- **ä¼˜åŠ¿**: å¿«é€Ÿæ•°æ®æ¢ç´¢å’ŒéªŒè¯
- **ç¤ºä¾‹**: "åˆ†æç”¨æˆ·å¹´é¾„ä¸è´­ä¹°åå¥½çš„å…³ç³»"

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

### 2. é…ç½®ç¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
# ClickZetta é…ç½®
CLICKZETTA_SERVICE=your-service
CLICKZETTA_INSTANCE=your-instance
CLICKZETTA_WORKSPACE=your-workspace
CLICKZETTA_SCHEMA=your-schema
CLICKZETTA_USERNAME=your-username
CLICKZETTA_PASSWORD=your-password
CLICKZETTA_VCLUSTER=your-vcluster

# DashScope é…ç½®
DASHSCOPE_API_KEY=your-dashscope-key
```

### 3. è¿è¡Œåº”ç”¨

```bash
streamlit run streamlit_app.py
```

## ğŸ“– ä½¿ç”¨è¯´æ˜

### åŸºæœ¬ä½¿ç”¨æµç¨‹

1. **ç³»ç»Ÿé…ç½®**
   - é…ç½® ClickZetta æ•°æ®åº“è¿æ¥
   - è®¾ç½® DashScope API Key
   - é€‰æ‹©ç›®æ ‡æ•°æ®åº“æ¨¡å¼

2. **æ•°æ®åº“æ¢ç´¢**
   - ç³»ç»Ÿè‡ªåŠ¨åŠ è½½è¡¨ç»“æ„ä¿¡æ¯
   - æŸ¥çœ‹æ•°æ®åº“æ¦‚è§ˆå’Œè¡¨åˆ—è¡¨
   - äº†è§£å¯ç”¨æ•°æ®èµ„æº

3. **è‡ªç„¶è¯­è¨€æŸ¥è¯¢**
   - ç”¨ä¸­æ–‡æè¿°æŸ¥è¯¢éœ€æ±‚
   - ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆ SQL è¯­å¥
   - å±•ç¤ºæŸ¥è¯¢ç»“æœå’Œæ•°æ®

4. **ç»“æœåˆ†æ**
   - æŸ¥çœ‹ç»“æ„åŒ–æ•°æ®è¡¨æ ¼
   - å¯¼å‡ºæŸ¥è¯¢ç»“æœä¸º CSV
   - åˆ†ææŸ¥è¯¢æ€§èƒ½ç»Ÿè®¡

### æŸ¥è¯¢ç¤ºä¾‹

#### åŸºç¡€æŸ¥è¯¢
```
è‡ªç„¶è¯­è¨€: "æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ·è¡¨"
ç”ŸæˆSQL: SHOW TABLES LIKE '%user%'

è‡ªç„¶è¯­è¨€: "æŸ¥è¯¢è®¢å•è¡¨çš„å‰10æ¡è®°å½•"
ç”ŸæˆSQL: SELECT * FROM orders LIMIT 10
```

#### ç»Ÿè®¡åˆ†æ
```
è‡ªç„¶è¯­è¨€: "ç»Ÿè®¡æ¯ä¸ªæœˆçš„è®¢å•æ•°é‡"
ç”ŸæˆSQL: SELECT DATE_FORMAT(order_date, '%Y-%m') as month, COUNT(*) as order_count
         FROM orders GROUP BY month ORDER BY month

è‡ªç„¶è¯­è¨€: "æ‰¾å‡ºé”€å”®é¢æœ€é«˜çš„å‰5ä¸ªäº§å“"
ç”ŸæˆSQL: SELECT product_name, SUM(amount) as total_sales
         FROM sales GROUP BY product_name ORDER BY total_sales DESC LIMIT 5
```

#### æ¡ä»¶ç­›é€‰
```
è‡ªç„¶è¯­è¨€: "æŸ¥è¯¢æœ€è¿‘30å¤©çš„æ´»è·ƒç”¨æˆ·"
ç”ŸæˆSQL: SELECT DISTINCT user_id FROM user_activity
         WHERE activity_date >= DATE_SUB(CURDATE(), INTERVAL 30 DAY)

è‡ªç„¶è¯­è¨€: "æ‰¾å‡ºè´­ä¹°é‡‘é¢è¶…è¿‡1000å…ƒçš„è®¢å•"
ç”ŸæˆSQL: SELECT * FROM orders WHERE total_amount > 1000 ORDER BY total_amount DESC
```

## ğŸ—ï¸ æŠ€æœ¯æ¶æ„

### æ ¸å¿ƒç»„ä»¶æ¶æ„

```mermaid
graph TD
    A[è‡ªç„¶è¯­è¨€æŸ¥è¯¢] --> B[LangChain SQL Chain]
    B --> C[DashScope é€šä¹‰åƒé—®]
    C --> D[SQL ç”Ÿæˆ]

    E[ClickZetta Engine] --> F[æ•°æ®åº“å…ƒæ•°æ®]
    F --> B

    D --> G[SQL æ‰§è¡Œ]
    G --> H[ClickZetta æ•°æ®åº“]
    H --> I[æŸ¥è¯¢ç»“æœ]

    I --> J[ç»“æœå¤„ç†]
    J --> K[æ•°æ®å¯è§†åŒ–]

    L[å¯¹è¯å†å²] --> M[èŠå¤©è®°å¿†]
    M --> B
```

### æ ¸å¿ƒä»£ç 

```python
# SQL é“¾åˆå§‹åŒ–
sql_chain = ClickZettaSQLChain.from_engine(
    engine=clickzetta_engine,
    llm=tongyi_llm,
    return_sql=True,  # è¿”å›ç”Ÿæˆçš„ SQL
    top_k=100  # æœ€å¤§ç»“æœè¡Œæ•°
)

# æ‰§è¡ŒæŸ¥è¯¢
response = sql_chain.invoke({
    "query": "æŸ¥è¯¢é”€å”®é¢æœ€é«˜çš„å‰10ä¸ªäº§å“",
    "chat_history": conversation_memory.buffer
})

# è§£æç»“æœ
sql_query = response["sql_query"]
answer = response["answer"]
```

### æ•°æ®æµç¨‹

1. **ç”¨æˆ·è¾“å…¥** â†’ è‡ªç„¶è¯­è¨€æŸ¥è¯¢
2. **ä¸Šä¸‹æ–‡æ„å»º** â†’ æ•°æ®åº“å…ƒæ•°æ® + å¯¹è¯å†å²
3. **SQL ç”Ÿæˆ** â†’ DashScope æ¨¡å‹æ¨ç†
4. **SQL æ‰§è¡Œ** â†’ ClickZetta æ•°æ®åº“æŸ¥è¯¢
5. **ç»“æœå¤„ç†** â†’ æ•°æ®æ ¼å¼åŒ–å’Œå¯è§†åŒ–
6. **å†å²è®°å½•** â†’ æŸ¥è¯¢è®°å½•ä¿å­˜

## ğŸ›ï¸ é…ç½®é€‰é¡¹

### æ•°æ®åº“è®¾ç½®

- **ç›®æ ‡æ¨¡å¼**: æŒ‡å®šè¦æŸ¥è¯¢çš„æ•°æ®åº“æ¨¡å¼
- **åŒ…å«ç¤ºä¾‹æ•°æ®**: åœ¨æç¤ºè¯ä¸­åŒ…å«è¡¨çš„ç¤ºä¾‹æ•°æ®
- **æœ€å¤§ç»“æœè¡Œæ•°**: é™åˆ¶æŸ¥è¯¢è¿”å›çš„æœ€å¤§è¡Œæ•°

### SQL ç”Ÿæˆè®¾ç½®

- **SQL ç”Ÿæˆåˆ›é€ æ€§**: æ§åˆ¶ SQL ç”Ÿæˆçš„åˆ›é€ æ€§ (å»ºè®® â‰¤ 0.2)
- **è¿”å› SQL è¯­å¥**: æ˜¯å¦åœ¨å›ç­”ä¸­æ˜¾ç¤ºç”Ÿæˆçš„ SQL
- **å¯ç”¨å¯¹è¯è®°å¿†**: è®°ä½å¯¹è¯å†å²ï¼Œæ”¯æŒä¸Šä¸‹æ–‡æŸ¥è¯¢

### é«˜çº§é…ç½®

```python
# è‡ªå®šä¹‰ SQL é“¾é…ç½®
sql_chain = ClickZettaSQLChain.from_engine(
    engine=engine,
    llm=llm,
    prompt=custom_sql_prompt,  # è‡ªå®šä¹‰æç¤ºè¯æ¨¡æ¿
    return_sql=True,
    top_k=1000,
    return_direct=False  # æ˜¯å¦ç›´æ¥è¿”å›SQLç»“æœ
)

# è‡ªå®šä¹‰æç¤ºè¯æ¨¡æ¿
custom_prompt = PromptTemplate(
    input_variables=["input", "table_info", "dialect"],
    template="""
    ä½ æ˜¯ä¸€ä¸ª ClickZetta æ•°æ®åº“ä¸“å®¶ã€‚åŸºäºä»¥ä¸‹è¡¨ä¿¡æ¯ç”Ÿæˆå‡†ç¡®çš„SQLæŸ¥è¯¢ï¼š

    æ•°æ®åº“ä¿¡æ¯ï¼š
    {table_info}

    ç”¨æˆ·æŸ¥è¯¢ï¼š{input}

    è¯·ç”Ÿæˆæ ‡å‡†çš„ ClickZetta SQL è¯­å¥ã€‚
    """
)
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### æŸ¥è¯¢ä¼˜åŒ–å»ºè®®

1. **è¡¨ç»“æ„ä¼˜åŒ–**
   ```sql
   -- ç¡®ä¿é‡è¦å­—æ®µæœ‰ç´¢å¼•
   CREATE INDEX idx_order_date ON orders(order_date);
   CREATE INDEX idx_user_id ON orders(user_id);
   ```

2. **æŸ¥è¯¢é™åˆ¶**
   ```python
   # è®¾ç½®åˆç†çš„ç»“æœè¡Œæ•°é™åˆ¶
   max_result_rows = 1000  # é¿å…è¿”å›è¿‡å¤šæ•°æ®
   ```

3. **ç¼“å­˜ç­–ç•¥**
   ```python
   # ç¼“å­˜è¡¨ç»“æ„ä¿¡æ¯
   @st.cache_data(ttl=3600)  # ç¼“å­˜1å°æ—¶
   def get_table_info(schema_name):
       return engine.get_table_info(schema=schema_name)
   ```

### æ€§èƒ½ç›‘æ§

- **æŸ¥è¯¢å“åº”æ—¶é—´**: ç›®æ ‡ < 3ç§’
- **SQL ç”Ÿæˆæ—¶é—´**: ç›®æ ‡ < 2ç§’
- **æ•°æ®ä¼ è¾“æ•ˆç‡**: ç›‘æ§å¤§ç»“æœé›†å¤„ç†
- **æˆåŠŸç‡ç»Ÿè®¡**: è·Ÿè¸ªæŸ¥è¯¢æˆåŠŸç‡

## ğŸ” æŸ¥è¯¢æŠ€å·§

### æŸ¥è¯¢è¯­è¨€æŠ€å·§

1. **æ˜ç¡®æŒ‡å®šè¡¨å**
   ```
   âŒ "æŸ¥è¯¢ç”¨æˆ·æ•°æ®"
   âœ… "æŸ¥è¯¢ users è¡¨ä¸­çš„ç”¨æˆ·æ•°æ®"
   ```

2. **å…·ä½“åŒ–æ¡ä»¶**
   ```
   âŒ "æŸ¥è¯¢æœ€è¿‘çš„è®¢å•"
   âœ… "æŸ¥è¯¢æœ€è¿‘7å¤©çš„è®¢å•æ•°æ®"
   ```

3. **æ˜ç¡®èšåˆéœ€æ±‚**
   ```
   âŒ "ç»Ÿè®¡é”€å”®æƒ…å†µ"
   âœ… "æŒ‰æœˆç»Ÿè®¡æ€»é”€å”®é¢å’Œè®¢å•æ•°é‡"
   ```

### ä¸Šä¸‹æ–‡æŸ¥è¯¢

åˆ©ç”¨å¯¹è¯è®°å¿†åŠŸèƒ½è¿›è¡Œè¿ç»­æŸ¥è¯¢ï¼š

```
ç¬¬1è½®: "æŸ¥è¯¢ 2024å¹´1æœˆçš„è®¢å•æ•°æ®"
ç¬¬2è½®: "ç»Ÿè®¡è¿™äº›è®¢å•çš„æ€»é‡‘é¢"  # è‡ªåŠ¨å…³è”ä¸Šä¸€è½®ç»“æœ
ç¬¬3è½®: "æŒ‰äº§å“ç±»åˆ«åˆ†ç»„æ˜¾ç¤º"   # ç»§ç»­åŸºäºå‰é¢çš„ä¸Šä¸‹æ–‡
```

### å¤æ‚æŸ¥è¯¢æ‹†è§£

å¯¹äºå¤æ‚éœ€æ±‚ï¼Œå¯ä»¥åˆ†æ­¥æŸ¥è¯¢ï¼š

```
å¤æ‚éœ€æ±‚: "åˆ†æç”¨æˆ·è´­ä¹°è¡Œä¸ºå’Œäº§å“å…³è”æ€§"

æ‹†è§£ä¸º:
1. "æŸ¥è¯¢ç”¨æˆ·è´­ä¹°è®°å½•è¡¨"
2. "ç»Ÿè®¡æ¯ä¸ªç”¨æˆ·çš„è´­ä¹°é¢‘æ¬¡"
3. "åˆ†æäº§å“å…±åŒè´­ä¹°æ¨¡å¼"
```

## ğŸ“ˆ ä¸šåŠ¡åº”ç”¨æ¡ˆä¾‹

### ç”µå•†æ•°æ®åˆ†æ

```python
# é”€å”®åˆ†ææŸ¥è¯¢ç¤ºä¾‹
queries = [
    "æŸ¥è¯¢æœ¬æœˆé”€å”®é¢TOP10çš„äº§å“",
    "ç»Ÿè®¡ä¸åŒå¹´é¾„æ®µç”¨æˆ·çš„è´­ä¹°åå¥½",
    "åˆ†æå•†å“é€€è´§ç‡å’ŒåŸå› åˆ†å¸ƒ",
    "æ‰¾å‡ºå¤è´­ç‡æœ€é«˜çš„ç”¨æˆ·ç¾¤ä½“"
]
```

### ç”¨æˆ·è¡Œä¸ºåˆ†æ

```python
# ç”¨æˆ·åˆ†ææŸ¥è¯¢ç¤ºä¾‹
queries = [
    "ç»Ÿè®¡æ¯æ—¥æ´»è·ƒç”¨æˆ·æ•°é‡è¶‹åŠ¿",
    "åˆ†æç”¨æˆ·ç•™å­˜ç‡å˜åŒ–æƒ…å†µ",
    "æ‰¾å‡ºä½¿ç”¨é¢‘ç‡æœ€é«˜çš„åŠŸèƒ½æ¨¡å—",
    "è¯†åˆ«æµå¤±é£é™©è¾ƒé«˜çš„ç”¨æˆ·ç‰¹å¾"
]
```

### è¿è¥æ•°æ®ç›‘æ§

```python
# è¿è¥ç›‘æ§æŸ¥è¯¢ç¤ºä¾‹
queries = [
    "æŸ¥è¯¢å„æ¸ é“çš„è½¬åŒ–ç‡æ•°æ®",
    "ç»Ÿè®¡è¥é”€æ´»åŠ¨çš„æ•ˆæœè¯„ä¼°",
    "åˆ†æä¸åŒæ—¶æ®µçš„ç”¨æˆ·æ´»è·ƒåº¦",
    "ç›‘æ§ç³»ç»Ÿå¼‚å¸¸å’Œé”™è¯¯æ—¥å¿—"
]
```

## â“ å¸¸è§é—®é¢˜

### Q: SQL ç”Ÿæˆä¸å‡†ç¡®æ€ä¹ˆåŠï¼Ÿ
A: å¯ä»¥å°è¯•ï¼š
- æ›´å…·ä½“åœ°æè¿°æŸ¥è¯¢éœ€æ±‚
- æ˜ç¡®æŒ‡å®šè¡¨åå’Œå­—æ®µå
- æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„æ˜¯å¦æ­£ç¡®
- è°ƒæ•´ SQL ç”Ÿæˆçš„åˆ›é€ æ€§å‚æ•°

### Q: æŸ¥è¯¢æ‰§è¡Œå¤±è´¥çš„åŸå› ï¼Ÿ
A: å¸¸è§åŸå› åŒ…æ‹¬ï¼š
- è¡¨åæˆ–å­—æ®µåä¸å­˜åœ¨
- æƒé™ä¸è¶³æ— æ³•è®¿é—®æŸäº›è¡¨
- SQL è¯­æ³•é”™è¯¯
- æ•°æ®ç±»å‹ä¸åŒ¹é…

### Q: å¦‚ä½•æé«˜æŸ¥è¯¢æ•ˆç‡ï¼Ÿ
A: å»ºè®®ï¼š
- ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µåˆ›å»ºç´¢å¼•
- é™åˆ¶æŸ¥è¯¢ç»“æœçš„è¡Œæ•°
- é¿å…å…¨è¡¨æ‰«ææ“ä½œ
- ä½¿ç”¨åˆé€‚çš„æŸ¥è¯¢æ¡ä»¶

### Q: å¯¹è¯è®°å¿†ä¸å·¥ä½œï¼Ÿ
A: æ£€æŸ¥ï¼š
- æ˜¯å¦å¯ç”¨äº†å¯¹è¯è®°å¿†åŠŸèƒ½
- ClickZetta è¿æ¥æ˜¯å¦æ­£å¸¸
- èŠå¤©å†å²è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ

## ğŸ“ æŠ€æœ¯æ”¯æŒ

### ç¤¾åŒºæ”¯æŒ
- GitHub Issues: [é—®é¢˜åé¦ˆ](https://github.com/yunqiqiliang/langchain-clickzetta/issues)
- ç¤¾åŒºè®¨è®º: [æŠ€æœ¯äº¤æµ](https://github.com/yunqiqiliang/langchain-clickzetta/discussions)

### ä¼ä¸šæ”¯æŒ
å¦‚éœ€ä¼ä¸šçº§æŠ€æœ¯æ”¯æŒå’Œå®šåˆ¶åŒ– SQL åˆ†æè§£å†³æ–¹æ¡ˆï¼Œè¯·è”ç³»äº‘å™¨ç§‘æŠ€å›¢é˜Ÿã€‚

## ğŸ‰ æ›´æ–°æ—¥å¿—

### v1.0.0
- âœ… è‡ªç„¶è¯­è¨€è½¬ SQL åŠŸèƒ½
- âœ… ClickZetta æ•°æ®åº“é›†æˆ
- âœ… DashScope æ¨¡å‹æ”¯æŒ
- âœ… å¯¹è¯è®°å¿†å’Œä¸Šä¸‹æ–‡ç†è§£
- âœ… æŸ¥è¯¢å†å²å’Œæ€§èƒ½ç»Ÿè®¡
- âœ… ç»“æœå¯è§†åŒ–å’Œå¯¼å‡º
- âœ… å¿«é€ŸæŸ¥è¯¢å»ºè®®

---

ğŸš€ **Powered by ClickZetta + DashScope + LangChain**

*è®©æ•°æ®æŸ¥è¯¢åƒèŠå¤©ä¸€æ ·ç®€å•*